trigger:
  branches:
    include:
      - main

pool:
  name: self-hosted-windows

steps:
  - checkout: self

  - powershell: |
      $ErrorActionPreference = "Stop"

      $py = "C:\Users\WINDOWS 11\AppData\Local\Programs\Python\Python311\python.exe"
      $scripts = "C:\Users\WINDOWS 11\AppData\Local\Programs\Python\Python311\Scripts"
      $aws = Join-Path $scripts "aws.exe"
      $sam = Join-Path $scripts "sam.cmd"

      & $py --version
      & $py -m pip install --upgrade pip
      & $py -m pip install awscli aws-sam-cli

      & $aws --version
      & $sam --version
    displayName: "Install AWS CLI + SAM CLI (Python 3.11)"

  - powershell: |
      $ErrorActionPreference = "Stop"
      $sam = "C:\Users\WINDOWS 11\AppData\Local\Programs\Python\Python311\Scripts\sam.cmd"
      & $sam build
    displayName: "SAM Build"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_DEFAULT_REGION: $(AWS_REGION)

  - powershell: |
      $ErrorActionPreference = "Stop"
      $sam = "C:\Users\WINDOWS 11\AppData\Local\Programs\Python\Python311\Scripts\sam.cmd"
      & $sam deploy `
        --stack-name "$(SAM_STACK_NAME)" `
        --region "$(AWS_REGION)" `
        --s3-bucket "$(SAM_S3_BUCKET)" `
        --capabilities CAPABILITY_IAM `
        --no-fail-on-empty-changeset
    displayName: "SAM Deploy"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_DEFAULT_REGION: $(AWS_REGION)
