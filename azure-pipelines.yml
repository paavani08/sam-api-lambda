trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

steps:
  - checkout: self

  - task: UsePythonVersion@0
    inputs:
      versionSpec: "3.11"

  - script: |
      python -m pip install --upgrade pip
      pip install awscli aws-sam-cli
      aws --version
      sam --version
    displayName: "Install AWS CLI + SAM CLI"

  - script: |
      set -e
      sam build
    displayName: "SAM Build"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_SESSION_TOKEN: $(AWS_SESSION_TOKEN)
      AWS_DEFAULT_REGION: $(AWS_REGION)

  - script: |
      set -e
      sam deploy \
        --stack-name "$(SAM_STACK_NAME)" \
        --region "$(AWS_REGION)" \
        --s3-bucket "$(SAM_S3_BUCKET)" \
        --capabilities CAPABILITY_IAM \
        --no-fail-on-empty-changeset
    displayName: "SAM Deploy"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_SESSION_TOKEN: $(AWS_SESSION_TOKEN)
      AWS_DEFAULT_REGION: $(AWS_REGION)
